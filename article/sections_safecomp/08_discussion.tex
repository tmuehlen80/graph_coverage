\section{Application: Analysing traffic scenes with coverage graphs}
\label{chapter:application}

Having defined a graph-based traffic scene representation, we can now analyse the coverage of the system.
Two methodologies are proposed for this purpose:
One is to define archetypes of traffice scenes, and to compare graphs from observed traffic scenes to these archetypes.
The second one is to translate graphs to graph embeddings, and then to compare the embeddings of different sets of traffic scenes.

\subsection{Subgraph Isomorphism Coverage Analysis}
We apply the subgraph isomorphism approach to both the  CARLA and the Argoverse data to identify coverage scenarios.
The archetypes used here are defined manually and described in table \ref{tab:subgraph_archetypes}. The chosen archetypes are typical traffic situations like e.g. 
lead vehicle situations, lane change situations or different combinations of opposite direction vehicles and intersections.

While the distributions of scenario characteristics between real-world and simulation data may differ, our primary objective is not to reproduce the exact real-world distribution. Instead, the goal is to systematically identify coverage gaps in the simulation dataset that could lead to insufficient testing of safety-critical scenarios. This gap analysis approach enables targeted improvements of the simulation dataset.

To comprehensively analyze coverage gaps, we employ three complementary methods: (1) identifying gaps in individual scenario archetypes, (2) analyzing gaps in combinations of co-occurring scenarios, and (3) examining gaps in parameter distributions within scenarios. These three perspectives provide a structured framework for understanding where the simulation dataset lacks representation of important real-world traffic situations.

\begin{table}[ht]
\centering
\caption{Overview of all subgraph archetypes with their structural properties. Edge types: \textit{fl} = following\_lead, \textit{lv} = leading\_vehicle, \textit{nv} = neighbor\_vehicle, \textit{ov} = opposite\_vehicle.}
\label{tab:subgraph_archetypes}
\begin{tabular}{llccl}
\toprule
\textbf{Group} & \textbf{Archetype} & \textbf{Actors} & \textbf{Edges} & \textbf{Edge Types} \\
\midrule
\multirow{3}{*}{Simple (2-actor)}
  & Simple Following           & 2 & 2 & fl, lv \\
  & Simple Opposite            & 2 & 2 & ov \\
  & Simple Neighbor            & 2 & 2 & nv \\
\midrule
\multirow{8}{*}{Complex (3-actor)}
  & Lead + Neighbor (intersection)       & 3 & 4 & fl, lv, nv \\
  & Cut-in                               & 3 & 4 & fl, lv \\
  & Cut-in (intersection)                & 3 & 4 & fl, lv \\
  & Platoon (intersection)               & 3 & 4 & fl, lv \\
  & Opposite Traffic (intersection)      & 3 & 4 & fl, lv, ov \\
  & Lead + Neighbor at Intersection      & 3 & 4 & fl, lv, nv \\
  & Triple Opposite (intersection)       & 3 & 4 & ov \\
  & Lead + Following in Back             & 3 & 4 & fl, lv \\
\midrule
\multirow{5}{*}{Complex (4-actor)}
  & Lead + Neighbor                      & 3 & 4 & fl, lv, nv \\
  & Cut-out                              & 4 & 6 & fl, lv, nv \\
  & Cut-out (intersection)               & 4 & 6 & fl, lv, nv \\
  & 4-Vehicle Platoon (intersection)     & 4 & 6 & fl, lv \\
  & 4-Vehicle Opposite (intersection)    & 4 & 6 & fl, lv, ov \\
\midrule
\multirow{2}{*}{Complex (5-actor)}
  & Lead + Neighbor + Opposite           & 5 & 8 & fl, lv, nv, ov \\
  & Lead + Neighbor + Opposite (inters.) & 5 & 8 & fl, lv, nv, ov \\
\bottomrule
\end{tabular}
\end{table}

\subsubsection{Individual Scenario Archetype Coverage}

Figure~\ref{fig:coverage_comparison} presents a comprehensive comparison of scenario archetype coverage between CARLA and Argoverse datasets. The dual-axis visualization displays coverage percentages (horizontal bars) alongside coverage differences (diamond markers). Red diamonds indicate scenarios that are more prevalent in Argoverse, while green diamonds mark scenarios with higher CARLA representation.

\begin{figure}[ht]
   \centering
   \includegraphics[width=0.95\textwidth]{plots/coverage_comparison_dual_axis.png}
   \caption{Scenario archetype coverage comparison between CARLA and Argoverse datasets. Horizontal bars show absolute coverage percentages, while diamond markers indicate coverage differences (CARLA minus Argoverse).}
   \label{fig:coverage_comparison}
\end{figure}

The coverage distribution reveals a clear pattern: CARLA achieves higher coverage only for the three simple two-actor scenarios (\texttt{simple\_following}, \texttt{simple\_neighbor}, \texttt{simple\_opposite}), as indicated by green diamond markers. For all complex multi-actor scenarios, Argoverse exhibits substantially higher occurrence rates (red diamond markers), demonstrating that the simulation systematically fails to generate complex traffic situations at the same frequency as observed in real-world data.

The identified coverage gaps in CARLA are substantial. The most critical gaps appear in intersection-related archetypes: \texttt{cut\_out\_intersection} shows nearly complete absence in CARLA (less than 1\% coverage) while appearing in approximately 8\% of Argoverse scenes, representing a gap of approximately 8 percentage points. Similarly, \texttt{lead\_neighbor\_opposite\_vehicle\_intersection} appears in roughly 6\% of Argoverse data but is virtually absent in CARLA (gap: $\sim$6 percentage points). The \texttt{cut\_in\_intersection} pattern exhibits a comparable gap of approximately 7 percentage points.

Notably, both \texttt{cut\_in} and \texttt{cut\_out} scenarios—fundamental lane change maneuvers—show significant underrepresentation in CARLA regardless of whether they occur at intersections. The \texttt{cut\_out} pattern appears in less than 1\% of CARLA scenes compared to roughly 5\% in Argoverse, while \texttt{cut\_in} shows a gap of approximately 5 percentage points. This systematic absence of lane change scenarios indicates that CARLA's traffic generation lacks the dynamic lateral maneuvers characteristic of real-world driving, limiting its ability to test autonomous systems in scenarios involving merging, overtaking, and lane changes.



% \subsubsection{Method 2: Co-occurrence Pattern Analysis}

% Beyond individual scenario coverage, real-world traffic scenes often contain multiple scenario archetypes simultaneously. Figure~\ref{fig:cooccurrence_diff} analyzes how combinations of archetypes differ between datasets.

% \begin{figure}[ht]
%    \centering
%    \includegraphics[width=0.95\textwidth]{plots/cooccurrence_difference_matrix.png}
%    \caption{Co-occurrence difference matrix between CARLA and Argoverse. Blue cells indicate archetype pairs that co-occur more frequently in Argoverse, while red cells show combinations more prevalent in CARLA. Cell intensity represents the magnitude of the difference in percentage points.}
%    \label{fig:cooccurrence_diff}
% \end{figure}

% The co-occurrence matrix reveals systematic patterns in how archetypes combine. Blue regions dominate the matrix, indicating that Argoverse exhibits substantially more co-occurrence of complex scenarios than CARLA. The strongest co-occurrence gaps appear in combinations involving intersection scenarios and simple following patterns: the joint occurrence of \texttt{simple\_following} with \texttt{opposite\_traffic\_at\_intersection} shows differences exceeding 20 percentage points, as does the combination with \texttt{lead\_with\_neighbor\_at\_intersection}.

% Notably, several intersection-related archetypes show deep blue columns and rows, suggesting that CARLA not only underrepresents these scenarios individually but also fails to generate them in realistic combination with other traffic patterns. For instance, \texttt{cut\_in\_intersection} rarely co-occurs with neighbor vehicles or opposite traffic in CARLA, despite these combinations being common in Argoverse. This reveals a fundamental gap: CARLA's intersection scenarios, when present, tend to appear in isolation rather than as part of richer, multi-archetype traffic situations.

% The few red regions indicate scenarios that co-occur more frequently in CARLA than in Argoverse, primarily involving simple patterns. This aligns with the observation that CARLA emphasizes simpler traffic configurations.

% The coverage gaps identified through both individual scenario analysis and co-occurrence patterns provide actionable insights for simulation improvement. The systematic underrepresentation of intersection scenarios and their combinations suggests that CARLA's scenario generation could benefit from enhanced intersection modeling and multi-actor interaction logic.

\subsubsection{Method 2: Parameter Distribution Gaps}

Even when a scenario archetype is structurally present in both datasets, the distributions of continuous parameters such as speed can reveal additional coverage gaps. To investigate parametric differences, we analyze role-specific speed distributions within the \texttt{lead\_vehicle\_in\_front\_with\_neighbor\_vehicle} scenario, a common highway situation with potential for lane changes.

Since each traffic scene graph contains multiple actors playing different roles within the scenario archetype, we must separate actors by their specific roles in the subgraph to obtain a meaningful comparison. In this three-actor scenario, role "a" represents the ego vehicle, role "b" is the leading vehicle in front of "a", and role "c" is the neighbor vehicle adjacent to "a". This role-based separation provides a detailed view of how different participants in the same scenario exhibit different parameter distributions.

\begin{figure}[ht!]
   \centering
   \includegraphics[width=0.8\textwidth]{plots/role_comparison_lead_vehicle_in_front_with_neighbor_vehicle.png}
   \caption{Role-specific speed distribution comparison for the lead vehicle in front with neighbor vehicle scenario. Green rectangles mark identified coverage gaps where Argoverse shows sufficient density but CARLA is nearly empty. The three panels show distributions for role "a" (ego vehicle), role "b" (lead vehicle), and role "c" (neighbor vehicle).}
   \label{fig:role_speed_comparison}
\end{figure}

Figure~\ref{fig:role_speed_comparison} reveals a systematic pattern: CARLA generally underrepresents higher velocities across all three actor roles. The distributions show that CARLA concentrates actors at lower speeds (peak around 3-5 m/s), while Argoverse exhibits more uniform distributions extending to higher speeds (15-20 m/s and beyond).

Coverage gaps are identified when a speed bin is sufficiently filled in Argoverse (indicating meaningful real-world occurrence) but nearly empty in CARLA (marked as green rectangles in the figure). For role "a" (ego vehicle), gaps appear in the 13-17 m/s range. Role "b" (lead vehicle) shows similar gaps at 13-16 m/s. Role "c" (neighbor vehicle) exhibits gaps at 13-16 m/s. These gaps consistently occur in the moderate-to-high speed range, indicating that CARLA fails to adequately represent highway-speed scenarios with neighboring vehicles, despite the structural scenario being present.

This role-specific parametric analysis demonstrates that coverage gaps exist not only at the structural level (which scenarios are present) and the co-occurrence level (which combinations appear), but also at the parameter level within structurally matching scenarios. The systematic underrepresentation of higher-speed conditions limits CARLA's utility for testing autonomous systems in realistic highway environments where lane changes and overtaking maneuvers typically occur at elevated speeds.


The structured, bottom-up approach presented here demonstrates that subgraph isomorphism can effectively characterize traffic scene coverage for predefined archetypes. However, the manual definition of archetypes and the computational cost of isomorphism checking for large scenario collections motivate the graph embedding approach explored in the following chapter.


\subsection{Graph Embeddings Coverage Analysis}

% \begin{figure}[ht]
%     \centering
%     \includegraphics[width=0.8\textwidth]{plots/train_test_graph_embeddings_loss_plot.png}
%     \caption{Training and test loss for the graph embeddings model trained jointly on CARLA and Argoverse 2.0 data.}
%     \label{fig:train_test_graph_embeddings_loss_plot}
% \end{figure}
    

The resulting embeddings have been analysed in a number of ways. For plausibility checks, for a number of 
randomly samples scenarios, the scenario with 
closest embedding vector (euclidean distance) has been visualized in figure \ref{fig:plausibility_checks}. It shows that the embeddings are able to capture the similarity between scenarios.


\begin{figure}[ht!]
    \centering
    \includegraphics[width=0.8\textwidth]{plots/graph_embeddings_pca_tsne_test_plot.png}
    \includegraphics[width=0.8\textwidth]{plots/PCA_density_plots_manually_cropped.png}
    \caption{Top row: PCA and t-SNE visualization of the embedding space for Carla and Argoverse 2.0 scenarios. Bottom row: PCA kernel density plots for Argoverse 2.0 scenarios.}
    \label{fig:embedding_space}
\end{figure}
    
As a next step, the embedding space has been analysed using dimension reduction techniques, specifically PCA and t-SNE. This is shown in Figure \ref{fig:embedding_space}. This can be done in a number of 
different flavors, like for example:

\begin{itemize}
    \item distinguishing between CARLA and Argoverse scenarios by a color coding, 
    \item visualizing just the CARLA scenarios and color code them by the map, in order to see if the maps deliver different types of scenarios,
    \item by calculating a density distribution of the embedding space for the Argoverse scenarios, and to check if for a regions with a density 
    about a certain threshold, there exist CARLA scenarios, i.e. do a coverage analysis in the embedded space
    \item do the same vice versa, i.e. to check for relevance of CARLA scenarios.
\end{itemize} %Okay, aber was machen wir? konzentrier dich darauf, pack die anderen Sachen in den Ausblick. 

As the embedding space is a normal metric space, representing scenarios across a large range of different driving situations, these embeddings can be used also for many other tasks, like for example clustering, anomaly detection, similarity search, etc.

And, as the main task considered here is coverage analysis, the embeddings can be used to check if a target distribution is met by a test distribution in the embedded space. 
Specifically, considering the Argoverse 2.0 scenarios as the target distribution, and the CARLA scenarios as the test distribution, the embeddings can be used to check 
if the CARLA scenarios cover the Argoverse 2.0 scenarios in the embedded space.


\begin{figure}[ht!]
    \centering
    \includegraphics[width=0.95\textwidth]{plots/graph_embeddings_comparison_plausibility_check_0.png}
    
    \includegraphics[width=0.95\textwidth]{plots/graph_embeddings_comparison_plausibility_check_1.png}
    
    \includegraphics[width=0.95\textwidth]{plots/graph_embeddings_comparison_plausibility_check_2.png}
    
    %\includegraphics[width=0.95\textwidth]{plots/graph_embeddings_comparison_plausibility_check_3.png}
    
    %\includegraphics[width=0.95\textwidth]{plots/graph_embeddings_comparison_plausibility_check_4.png}

    \caption{Plausibility checks showing graph embedding comparisons. For randomly sampled scenarios, the most similar scenarios based on embedding distance (both Euclidean and cosine) are visualized, including comparisons between CARLA and Argoverse scenarios.}
    \label{fig:plausibility_checks}
\end{figure}

