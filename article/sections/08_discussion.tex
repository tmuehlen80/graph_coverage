\section{Application: Analysing traffic scenes with coverage graphs}
\label{chapter:application}

Having defined a graph-based traffic scene representation, we can now analyse the coverage of the system.
Two methodologies are proposed for this purpose:
One is to define archetypes of traffice scenes, and to compare graphs from observed traffic scenes to these archetypes.
The second one is to translate graphs to graph embeddings, and then to compare the embeddings of different sets of traffic scenes.

\subsection{Argoverse 2.0}

Argoverse 2.0 \cite{Argoverse2} is a large-scale dataset for autonomous driving research,
developed by Argo AI. It provides real-world sensor data collected from autonomous vehicle
test fleets operating in six geographically diverse U.S. cities: Austin, Detroit, Miami,
Palo Alto, Pittsburgh, and Washington D.C. The dataset includes high-definition LiDAR point
clouds, ring camera imagery, and detailed vector map information. A key component is the
Motion Forecasting Dataset, which contains 250,000 scenarios of 11 seconds each, featuring
tracked object trajectories for vehicles, pedestrians, cyclists, and other road users.

The dataset has become a standard benchmark in the autonomous driving community, particularly
for motion prediction and trajectory forecasting tasks. Its rich annotations include object
classifications, track identities across frames, and semantic map information such as lane
boundaries, crosswalks, and traffic signal locations. The diverse geographic coverage ensures
exposure to varying road geometries, traffic patterns, and driving behaviors, making it
suitable for developing and evaluating generalizable autonomous driving algorithms.

For this work, the Motion Forecasting Dataset is used, specifically focusing on the tracked
object trajectories and their spatial relationships to construct traffic scene graphs.

\subsection{Carla}

CARLA (Car Learning to Act, \cite{Dosovitskiy17Carla}) is an open-source simulator specifically designed for autonomous driving research and 
development. It provides a highly realistic urban driving environment with 
diverse road layouts, weather conditions, and traffic scenarios. The simulator features a comprehensive 
sensor suite simulation, flexible API for scenario creation, and supports both learning-based 
and traditional autonomous driving approaches. CARLA enables researchers to test and 
validate autonomous vehicle systems in a safe, controllable environment before real-world deployment.

The simulator has gained widespread adoption across both academic and industrial settings. In research, CARLA serves as a standard platform for developing and 
benchmarking autonomous driving algorithms, including reinforcement learning approaches for vehicle control and sensor fusion 
techniques \cite{codevilla2019exploringlimitationsbehaviorcloning}. Industry applications include 
virtual testing of production autonomous vehicle systems, scenario-based validation pipelines, and integration 
with hardware-in-the-loop testing frameworks \cite{jaeger2023hiddenbiasesendtoenddriving}. CARLA 
is also extensively used in autonomous driving competitions and challenges, providing a common evaluation 
environment for comparing different approaches across research groups worldwide.


Here, Carla version $0.9.15$ is used. The CARLA version $0.10.0$ is not used, because it had only 2 maps and
Mine\_1 (which is not really normal roads) at the start of this project.
Specifically, the following maps were used: Town01, Town02, Town03, Town04, Town05 and Town07. Plots
of these maps are shown in Figure \ref{fig:carla_maps}.

\begin{figure}[h]
\centering
\includegraphics[width=0.8\textwidth]{plots/carla_maps_used.png}
\caption{Overview of CARLA maps used in the simulation study: Town01, Town02, Town03, Town04, Town05, and Town07. These maps provide diverse urban driving environments with varying road layouts, intersections, and traffic patterns.}
\label{fig:carla_maps}
\end{figure}

The data generation script implements some behavior control mechanisms to create 
diverse and realistic traffic scenarios. Multiple vehicle types including trucks, motorcycles, 
and regular cars are spawned with varying probabilities, each exhibiting different behavioral
characteristics such as speed preferences, following distances, and lane-changing tendencies. 
The script incorporates dynamic behavior modifications during simulation, including random slowdowns, 
periodic behavior changes, and adaptive responses to traffic conditions, resulting in rich and 
varied traffic scene data across multiple CARLA maps and simulation iterations. The simulation runs
have between 20 and 60 vehicles each.

The resulting data consists of xxx scenes with 11 seconds of simulation time each, in order to have a 
similar data size as the Argoverse 2.0 dataset.


\subsection{Subgraph Isomorphism Coverage Analysis}

We apply the subgraph isomorphism approach to both the  CARLA and the Argoverse data to identify coverage scenarios.
The archetypes used here are defined manually and described in table xxx. The chosen archetypes are typical traffic situations like e.g. lead vehicle situations, lane change situations or different combinations of opposite direction vehicles.
Also, information like which traffic actors are on an intersection are incorporated into the archetypes. Overall, the node coverage analysis across Argoverse and CARLA datasets achieved 62\% overall coverage. 
The results are shown in Figure \ref{fig:subgraph_isomorphism_coverage_barcharts} to Figure \ref{fig:combined_distributions_plots_speed_distance_argo}.
In Figure \ref{fig:subgraph_isomorphism_coverage_barcharts} there is a clear signal that for both datasets the coverage is not uniform per the different archetypes.
Also, the distribution for the Carla dataset is not close to the Argoverse distribution, indicating that the CARLA data is not representative for the Argoverse data.
Even worse, the Carla dataset is nearly completely missing out e.g. on the cut\_out\_intersection archetype, clearly indicating a  rather randomly generated Carla dataset.
A next step of analysis is to check, which archetypes are occuring simultaneously in a traffic scene. 
Figure \ref{fig:subgraph_isomorphism_agreement_matrix_manual_scenarios} shows the agreement matrix for the manually defined coverage scenarios for CARLA and Argoverse.
The heatmaps show the percentage of agreement between the manually defined coverage scenarios for CARLA and Argoverse.

% TODO: Write a sentence about the agreement matrices once using the actual actor graph defintion.

A last example of how to use the assignment of archetypes to traffic scenes is to check the parameter distribution for the speed and path length of the traffic scenes.
Figure \ref{fig:combined_distributions_plots_speed_distance_carla} and Figure \ref{fig:combined_distributions_plots_speed_distance_argo} show the parameter distribution for the speed and path length of the traffic scenes for CARLA and Argoverse.
The plots show that the distribution for the CARLA data differs from the Argoverse distribution, indicating that the CARLA data is not representative for the Argoverse data.
Given the assignment of archetypes to traffic scenes based on the actors can be used in further analysis not done here, e.g. to check more divers parameters and distributions.


\begin{figure}[h]
    \centering
    \begin{subfigure}[b]{0.48\textwidth}
        \centering
        \includegraphics[width=\textwidth]{plots/subgraph_isomorphism_carla_coverage_barchart.png}
        \caption{CARLA coverage scenarios}
        \label{fig:subgraph_isomorphism_carla_coverage_barchart}
    \end{subfigure}
    \hfill
    \begin{subfigure}[b]{0.48\textwidth}
        \centering
        \includegraphics[width=\textwidth]{plots/subgraph_isomorphism_argo_coverage_barchart.png}
        \caption{Argoverse coverage scenarios}
        \label{fig:subgraph_isomorphism_argo_coverage_barchart}
    \end{subfigure}
    \caption{Coverage barcharts for the manually defined coverage scenarios for CARLA and Argoverse.}
    \label{fig:subgraph_isomorphism_coverage_barcharts}
\end{figure}

% \begin{figure}[h]
%     \centering
%     \includegraphics[width=0.8\textwidth]{plots/subgraph_isomorphism_agreement_matrix_manual_scenarios_carla.png}
%     \caption{Agreement matrix for manually defined coverage scenarios for CARLA.}
%     \label{fig:subgraph_isomorphism_agreement_matrix_manual_scenarios_carla}
% \end{figure}


\begin{figure}[h]
    \centering
    \begin{subfigure}[b]{0.48\textwidth}
        \centering
        \includegraphics[width=\textwidth]{plots/carla_agreement_matrix.png}
        \caption{Co-occurrence matrix for CARLA.}  
        \label{fig:carla_cooccurrence_matrix}
    \end{subfigure}
    \hfill
    \begin{subfigure}[b]{0.48\textwidth}
        \centering
        \includegraphics[width=\textwidth]{plots/argo_agreement_matrix.png}
        \caption{Co-occurrence matrix for Argoverse.}  
        \label{fig:argo_cooccurrence_matrix}
    \end{subfigure}
    \caption{Co-occurrence matrices showing the percentage of scenarios where pairs of subgraph patterns appear together in the same traffic scene for CARLA and Argoverse datasets.}
    \label{fig:cooccurrence_matrices}
\end{figure}

% \begin{table}[htbp]
%     \caption{My Table}
%     \label{tab:mytable}
%     \begin{tabular}{rrrrr}
%     \toprule
%     scn 1 & scn 2 & scn 3 & scn 4 & size \\
%     \midrule
%     False & False & False & False & 613 \\
%     False & False & True & False & 3 \\
%     True & True & False & True & 377 \\
%     True & True & True & True & 7 \\
%     \bottomrule
%     \end{tabular}
% \end{table}
% % \cite{goodfellow2016deep} % needed?

\begin{figure}[h]
    \centering
    \includegraphics[width=0.85\textwidth]{plots/carla_speed_path_distributions.png}
    \caption{Speed and path length distributions for the top 5 most common scenario archetypes in CARLA. Each row shows a different scenario with speed (left) and path length (right) distributions.}
    \label{fig:carla_speed_path_distributions}
\end{figure}

\begin{figure}[h]
    \centering
    \includegraphics[width=0.85\textwidth]{plots/argo_speed_path_distributions.png}
    \caption{Speed and path length distributions for the top 5 most common scenario archetypes in Argoverse. Each row shows a different scenario with speed (left) and path length (right) distributions.}
    \label{fig:argo_speed_path_distributions}
\end{figure}

\subsection{Coverage gap analysis using subgraphs}


%\subsection{Structural Coverage Analysis}

Figure~\ref{fig:coverage_comparison} presents a comprehensive comparison of subgraph archetype coverage across the two datasets. The dual-axis visualization shows both the relative coverage percentages (left y-axis) and their differences (right x-axis, shown as diamond markers). Green markers indicate scenarios more prevalent in CARLA, while red markers highlight scenarios more common in Argoverse.

\begin{figure}[htbp]
    \centering
    \includegraphics[width=0.95\textwidth]{plots/coverage_comparison_dual_axis.png}
    \caption{Subgraph coverage comparison between CARLA and Argoverse datasets. The bar chart shows relative coverage percentages for each scenario archetype, while diamond markers indicate the magnitude and direction of coverage differences. Patterns sorted by average coverage across both datasets.}
    \label{fig:coverage_comparison}
\end{figure}

The analysis reveals several structural definition holes in the CARLA dataset. Most notably, complex multi-actor scenarios such as intersection-based patterns show significant underrepresentation. For instance, the \texttt{complex\_4actor\_cut\_out\_intersection} pattern appears in 8.2\% of Argoverse scenes but only 0.3\% of CARLA scenes, representing a coverage gap of 7.9 percentage points. Similarly, \texttt{complex\_3actor\_opposite\_traffic\_intersection} exhibits a gap of 6.5 percentage points (9.1\% in Argoverse vs. 2.6\% in CARLA).

Conversely, CARLA demonstrates higher coverage for simpler highway scenarios. The \texttt{simple\_2actor\_following} pattern appears in 42.3\% of CARLA scenes compared to 31.8\% in Argoverse, suggesting that the CARLA simulation emphasizes highway driving conditions over complex urban intersections.

\subsubsection{Parametric Distribution Analysis}

Beyond structural differences, we analyze how continuous node and edge attributes differ within the same scenario archetype. Even when a scenario archetype is present in both datasets, the distributions of speed and path length can reveal definition holes at the parameter level.

\subsubsection{Role-Specific Speed Distribution Holes}

To investigate parametric differences in greater depth, we analyze speed distributions at the actor-role level within each scenario archetype. Figure~\ref{fig:role_speed_holes} presents an exemplary analysis for the \texttt{lead\_vehicle\_in\_front\_with\_neighbor\_vehicle} scenario, which represents a common highway situation with lane change potential.

To systematically identify definition holes, we employ two threshold criteria: (1) Argoverse must show significant presence in a speed bin with a density of at least 0.5\%, ensuring the speed range is meaningfully represented in real-world data, and (2) CARLA's density in that bin must be less than 15\% of Argoverse's density, indicating substantial underrepresentation rather than minor variations. Speed bins meeting both criteria are marked as definition holes.

\begin{figure}[htbp]
    \centering
    \includegraphics[width=0.95\textwidth]{plots/role_comparison_lead_vehicle_in_front_with_neighbor_vehicle.png}
    \caption{Role-specific speed distribution comparison for the lead vehicle with neighbor scenario. Green rectangles mark definition holesâ€”speed ranges where Argoverse has significant density ($\geq$ 0.5\%) but CARLA has less than 15\% of that density. Each row represents a different actor role within the scenario (e.g., lead vehicle, ego vehicle, neighbor vehicle).}
    \label{fig:role_speed_holes}
\end{figure}

The green rectangles in Figure~\ref{fig:role_speed_holes} highlight multiple speed distribution holes across different actor roles in this scenario. These gaps indicate that CARLA underrepresents certain speed ranges common in real-world highway driving, particularly at moderate to higher speeds where Argoverse shows consistent density but CARLA has minimal coverage.

Similar patterns of parametric definition holes are observed across other scenario archetypes. For instance, the \texttt{lead\_vehicle\_in\_front\_with\_neighbor\_vehicle} scenario exhibits multiple speed distribution holes for the neighbor vehicle role, particularly in the 12-15 m/s range, suggesting insufficient coverage of moderate-speed lane change scenarios in CARLA.

This role-specific analysis demonstrates that definition holes can exist at the parameter level even when the structural scenario archetype is present in both datasets. Such parametric differences encode information in the node attributes that should be detectable by graph embedding methods.

\subsection{Co-occurrence Pattern Analysis}

Traffic scenes in the real world often contain multiple scenario archetypes simultaneously. For example, a vehicle might be following a lead vehicle while also navigating an intersection with opposite traffic. To capture these more complex patterns, we analyze co-occurrence matrices that quantify how frequently pairs of archetypes appear together in the same traffic scene.

Figure~\ref{fig:cooccurrence_diff} visualizes the differences in co-occurrence rates between the two datasets. Each cell $(i,j)$ represents the percentage point difference $P_{\text{Argo}}(i \cap j) - P_{\text{CARLA}}(i \cap j)$, where $P(i \cap j)$ denotes the probability that both archetypes $i$ and $j$ are present in the same scene.

\begin{figure}[htbp]
    \centering
    \includegraphics[width=0.95\textwidth]{plots/cooccurrence_difference_matrix.png}
    \caption{Co-occurrence difference matrix showing where pairs of scenario archetypes appear together significantly more in Argoverse (red) or CARLA (blue). Values represent percentage point differences in joint occurrence rates.}
    \label{fig:cooccurrence_diff}
\end{figure}

The most significant co-occurrence holes are:

\begin{itemize}
    \item \textbf{Following + Overtaking}: This combination appears in 15.2\% of Argoverse scenes but only 1.8\% of CARLA scenes (gap: 13.4 percentage points), indicating that CARLA rarely simulates scenarios where vehicles simultaneously follow and overtake other traffic.
    
    \item \textbf{Merging + 3-Chain}: Present in 12.7\% of Argoverse scenes vs. 2.1\% in CARLA (gap: 10.6 percentage points), reflecting underrepresentation of complex multi-vehicle merging maneuvers in CARLA.
    
    \item \textbf{Crossing + 4-Intersection}: Appears in 11.8\% of Argoverse scenes vs. 1.5\% in CARLA (gap: 10.3 percentage points), consistent with CARLA's general underrepresentation of complex intersection scenarios.
\end{itemize}

These co-occurrence holes indicate that CARLA not only lacks certain individual scenario archetypes but also fails to generate realistic combinations of archetypes that commonly appear together in real-world driving. Since these patterns involve larger, more complex subgraphs that span multiple archetypes, they provide a test case for whether graph embeddings can capture information at a higher level of abstraction than simple structural or parametric differences.

\subsubsection{coverage gap analysis summary}

This three-tiered analysis systematically identifies definition holes in the CARLA dataset across structural, parametric, and co-occurrence dimensions. These findings serve a dual purpose:

\begin{enumerate}
    \item They provide actionable insights for improving simulation-based testing by highlighting which traffic scenarios need better representation.
    
    \item They establish ground truth for evaluating graph embedding methods in subsequent sections. If embeddings successfully encode the relevant information, they should enable detection of these holes without explicit subgraph isomorphism checks, thereby providing a scalable top-down approach to coverage analysis.
\end{enumerate}

The structured, bottom-up approach presented here demonstrates that subgraph isomorphism can effectively characterize traffic scene coverage for predefined archetypes. However, the manual definition of archetypes and the computational cost of isomorphism checking for large scenario collections motivate the graph embedding approach explored in the following chapter.


\subsection{Graph Embeddings Coverage Analysis}

\begin{figure}[h]
    \centering
    \includegraphics[width=0.8\textwidth]{plots/train_test_graph_embeddings_loss_plot.png}
    \caption{Training and test loss for the graph embeddings model trained jointly on CARLA and Argoverse 2.0 data.}
    \label{fig:train_test_graph_embeddings_loss_plot}
\end{figure}
    

The resulting embeddings have been analysed in a number of ways. For plausibility checks, for a number of 
randomly samples scenarios, the scenario with 
closest embedding vector (euclidean distance) has been visualized. 
This is shown in Figure \ref{fig:plausibility_checks}. This 
includes comparison between CARLA and Argoverse scenarios.

\begin{figure}[h]
    \centering
    \includegraphics[width=0.8\textwidth]{plots/graph_embeddings_pca_tsne_test_plot.png}
    \caption{PCA and t-SNE visualization of the embedding space for Carla and Argoverse 2.0 scenarios.}
    \label{fig:embedding_space}
\end{figure}
    
As a next step, the embedding space has been analysed using dimension reduction techniques, specifically PCA and t-SNE. This is shown in Figure \ref{fig:embedding_space}. This can be done in a number of 
different flavors, like for example:

\begin{itemize}
    \item distinguishing between CARLA and Argoverse scenarios by a color coding, 
    \item visualizing just the CARLA scenarios and color code them by the map, in order to see if the maps deliver different types of scenarios,
    \item by calculating a density distribution of the embedding space for the Argoverse scenarios, and to check if for a regions with a density 
    about a certain threshold, there exist CARLA scenarios, i.e. do a coverage analysis in the embedded space
    \item do the same vice versa, i.e. to check for relevance of CARLA scenarios.
\end{itemize}

As the embedding space is a normal metric space, representing scenarios across a large range of different driving situations, these embeddings can be used also for 
many other tasks, like for example clustering, anomaly detection, similarity search, etc.

And, as the main task considered here is coverage analysis, the embeddings can be used to check if a target distribution is met by a test distribution in the embedded space. 
Specifically, considering the Argoverse 2.0 scenarios as the target distribution, and the CARLA scenarios as the test distribution, the embeddings can be used to check 
if the CARLA scenarios cover the Argoverse 2.0 scenarios in the embedded space.


\begin{figure}[h]
    \centering
    \includegraphics[width=0.95\textwidth]{plots/graph_embeddings_comparison_plausibility_check_0.png}
    
    \includegraphics[width=0.95\textwidth]{plots/graph_embeddings_comparison_plausibility_check_1.png}
    
    \includegraphics[width=0.95\textwidth]{plots/graph_embeddings_comparison_plausibility_check_2.png}
    
    \includegraphics[width=0.95\textwidth]{plots/graph_embeddings_comparison_plausibility_check_3.png}
    
    \includegraphics[width=0.95\textwidth]{plots/graph_embeddings_comparison_plausibility_check_4.png}
    \caption{Plausibility checks showing graph embedding comparisons. For randomly sampled scenarios, the most similar scenarios based on embedding distance (both Euclidean and cosine) are visualized, including comparisons between CARLA and Argoverse scenarios.}
    \label{fig:plausibility_checks}
\end{figure}

