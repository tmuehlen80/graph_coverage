\section{Create subgraphs for coverage analysis}
\label{chapter:create_subgraphs_for_coverage_analysis}

There is a lot of knowledge in the literature on how to define archetypes of traffic scenes, like e.g. with lead vehicle or opposite traffic vehicles in different circumstances.
Once an archetype is define and expressed as graph, a special property of graphs can be used. 
Two graphs are isomorphic if they have the same structure, regardless of the node and edge labels.
As the archetypes are not necessarily involving a lot of actors, these are more like subsets of actual traffic scenes.
A very simple example might be 2 vehicles on the same lane, driving in the same direction and another vehicle driving on a neighboring lane.
This situation can be represented by a graph with 3 nodes and 2 edges. 
In most real traffic situations however, there will be additional actors present, so that we are not searching for isomorphic graphs, but rather want to check if any subgraph of $G$ is isomorphic to the archetype graph $A$.
This is an example of a subgraph isomorphism problem.
While this problem is NP-hard, the graphs considered here are rather small, so the computational time is reasonable.
One such algorithm is the VF2 algorithm, which is implemented in the NetworkX library (see \cite{cordella2004subgraph}).
The strategy we are then applying is the following:

\begin{enumerate}
    \item Define a set of subgraphs $S$ that are considered to be archetypes of traffic scenes, e.g. unprotected left turns with opposite traffic or lead vehicle following situations.
    \item Define which node and edge attributes are considered for the isomorphism check.
    \item Create an empty dataframe $C$ with a column for each subgraph in $S$
    \item Define the set of traffice scenes (e.g. from Carla or Argoverse) defined as graphs $G$
    \item For each graph $G$, check if any subgraph of $G$ is isomorphic to any subgraph in $S$ and note the result in a new row in table $C$
\end{enumerate}

This strategy can be described to some degree as a bottom up approach: Starting from a detail level, individual situations are defined.
Then going upwards to different datasets, it is checked, if the archetype is present.
Also, follow up analysis of the created coverage dataframe can be performed. For example,

\begin{itemize}
    \item The distribution of numeric attributes like speed and and distance to other actors can be visualized for the set of all traffic scenes which are subgraph isomorphic to an archetype.
    \item It can be cross tabulated, which combinations of archetypes are jointly present in a traffic scene.
    \item Pass Fail rates or other AV performance metrics can be calculated for the subset of all traffic scenes which are subgraph isomorphic to an archetype.
\end{itemize}

In our case, we defined 18 subgraph archetypes covering common traffic scenarios:
\begin{itemize}
    \item Simple 2-actor patterns (only used if 2 actors are isolated): following, opposite traffic, and neighboring vehicles
    \item Complex 3-actor patterns: lead vehicle with neighbor, platoon formations, opposite traffic configurations, and lane change scenarios (cut-in), with variants at intersections
    \item Complex 4-actor patterns: cut-out scenarios, multi-vehicle platoons, and lead-following with opposite traffic, with intersection variants
    \item Complex 5-actor patterns: combined lead, neighbor, and opposite vehicle scenarios with intersection variants
\end{itemize}
The node coverage analysis across Argoverse and CARLA datasets achieved 62\% overall coverage. It is posible to define more archetypes or detect them automatically, 
but this is out of scope for this project.

